<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /readme.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# <img src="/src/icon.png" height="30px"> GraphQL.Validation

[![Build status](https://ci.appveyor.com/api/projects/status/wvk8wm3n227b2b3q/branch/master?svg=true)](https://ci.appveyor.com/project/SimonCropp/graphql-validation) [![NuGet Status](https://img.shields.io/nuget/v/GraphQL.FluentValidation.svg?cacheSeconds=86400)](https://www.nuget.org/packages/GraphQL.FluentValidation/)

Add [FluentValidation](https://fluentvalidation.net/) support to [GraphQL.net](https://github.com/graphql-dotnet/graphql-dotnet)

<!-- toc -->
## Contents

  * [NuGet](#nuget)
  * [Usage](#usage)
    * [Define validators](#define-validators)
    * [Setup Validators](#setup-validators)
    * [Add to ExecutionOptions](#add-to-executionoptions)
    * [UserContext must be a dictionary](#usercontext-must-be-a-dictionary)
    * [Trigger validation](#trigger-validation)
<!-- endtoc -->



## NuGet

https://nuget.org/packages/GraphQL.FluentValidation/


## Usage


### Define validators

Given the following input:

<!-- snippet: input -->
<a id='snippet-input'/></a>
```cs
public class MyInput
{
    public string Content { get; set; } = null!;
}
```
<sup>[snippet source](/src/SampleWeb/Graphs/MyInput.cs#L1-L8) / [anchor](#snippet-input)</sup>
<!-- endsnippet -->

And graph:

<!-- snippet: graph -->
<a id='snippet-graph'/></a>
```cs
public class MyInputGraph :
    InputObjectGraphType
{
    public MyInputGraph()
    {
        Field<StringGraphType>("content");
    }
}
```
<sup>[snippet source](/src/SampleWeb/Graphs/MyInputGraph.cs#L3-L12) / [anchor](#snippet-graph)</sup>
<!-- endsnippet -->

A custom validator can be defined as follows:

<!-- snippet: validator -->
<a id='snippet-validator'/></a>
```cs
public class MyInputValidator :
    AbstractValidator<MyInput>
{
    public MyInputValidator()
    {
        RuleFor(_ => _.Content)
            .NotEmpty();
    }
}
```
<sup>[snippet source](/src/SampleWeb/Graphs/MyInputValidator.cs#L3-L13) / [anchor](#snippet-validator)</sup>
<!-- endsnippet -->


### Setup Validators

Validators need to be added to the `ValidatorTypeCache`. This should be done once at application startup.

<!-- snippet: StartConfig -->
<a id='snippet-startconfig'/></a>
```cs
var validatorTypeCache = new ValidatorTypeCache();
validatorTypeCache.AddValidatorsFromAssembly(assemblyContainingValidators);
var schema = new Schema();
var executer = new DocumentExecuter();
```
<sup>[snippet source](/src/Tests/Snippets/QueryExecution.cs#L18-L25) / [anchor](#snippet-startconfig)</sup>
<!-- endsnippet -->

Generally `ValidatorTypeCache` is scoped per app and can be collocated with `Schema`, `DocumentExecuter` initialization.


### Add to ExecutionOptions

Validation needs to be added to any instance of `ExecutionOptions`.

<!-- snippet: UseFluentValidation -->
<a id='snippet-usefluentvalidation'/></a>
```cs
var options = new ExecutionOptions
{
    Schema = schema,
    Query = queryString,
    Inputs = inputs
};
options.UseFluentValidation(validatorTypeCache);

var executionResult = await executer.ExecuteAsync(options);
```
<sup>[snippet source](/src/Tests/Snippets/QueryExecution.cs#L30-L42) / [anchor](#snippet-usefluentvalidation)</sup>
<!-- endsnippet -->


### UserContext must be a dictionary

This library needs to be able to pass the list of validators, in the form of `ValidatorTypeCache`, through the graphql context. The only way of achieving this is to use the `ExecutionOptions.UserContext`. To facilitate this, the type passed to `ExecutionOptions.UserContext` has to implement `IDictionary<string, object>`. There are two approaches to achieving this:


#### 1. Have the user context class implement IDictionary

Given a user context class of the following form:

<!-- snippet: ContextImplementingDictionary -->
<a id='snippet-contextimplementingdictionary'/></a>
```cs
public class MyUserContext :
    Dictionary<string, object>
{
    public MyUserContext(string myProperty)
    {
        MyProperty = myProperty;
    }

    public string MyProperty { get; }
}
```
<sup>[snippet source](/src/Tests/Snippets/QueryExecution.cs#L45-L58) / [anchor](#snippet-contextimplementingdictionary)</sup>
<!-- endsnippet -->

The `ExecutionOptions.UserContext` can then be set as follows:

<!-- snippet: ExecuteQueryWithContextImplementingDictionary -->
<a id='snippet-executequerywithcontextimplementingdictionary'/></a>
```cs
var options = new ExecutionOptions
{
    Schema = schema,
    Query = queryString,
    Inputs = inputs,
    UserContext = new MyUserContext
    (
        myProperty: "the value"
    )
};
options.UseFluentValidation(validatorTypeCache);
```
<sup>[snippet source](/src/Tests/Snippets/QueryExecution.cs#L62-L76) / [anchor](#snippet-executequerywithcontextimplementingdictionary)</sup>
<!-- endsnippet -->


#### 2. Have the user context class exist inside a IDictionary

<!-- snippet: ExecuteQueryWithContextInsideDictionary -->
<a id='snippet-executequerywithcontextinsidedictionary'/></a>
```cs
var options = new ExecutionOptions
{
    Schema = schema,
    Query = queryString,
    Inputs = inputs,
    UserContext = new Dictionary<string, object>
    {
        {
            "MyUserContext",
            new MyUserContext
            (
                myProperty: "the value"
            )
        }
    }
};
options.UseFluentValidation(validatorTypeCache);
```
<sup>[snippet source](/src/Tests/Snippets/QueryExecution.cs#L81-L101) / [anchor](#snippet-executequerywithcontextinsidedictionary)</sup>
<!-- endsnippet -->


#### No UserContext

If no instance is passed to `ExecutionOptions.UserContext`:

<!-- snippet: NoContext -->
<a id='snippet-nocontext'/></a>
```cs
var options = new ExecutionOptions
{
    Schema = schema,
    Query = queryString,
    Inputs = inputs
};
options.UseFluentValidation(validatorTypeCache);
```
<sup>[snippet source](/src/Tests/Snippets/QueryExecution.cs#L106-L116) / [anchor](#snippet-nocontext)</sup>
<!-- endsnippet -->

Then the `UseFluentValidation` method will instantiate it to a new `Dictionary<string, object>`.


### Trigger validation

To trigger the validation, when reading arguments use `GetValidatedArgument` instead of `GetArgument`:

<!-- snippet: GetValidatedArgument -->
<a id='snippet-getvalidatedargument'/></a>
```cs
public class Query :
    ObjectGraphType
{
    public Query()
    {
        Field<ResultGraph>(
            "inputQuery",
            arguments: new QueryArguments(
                new QueryArgument<MyInputGraph>
                {
                    Name = "input"
                }
            ),
            resolve: context =>
            {
                var input = context.GetValidatedArgument<MyInput>("input");
                return new Result
                {
                    Data = input.Content
                };
            }
        );
    }
}
```
<sup>[snippet source](/src/SampleWeb/Query.cs#L4-L31) / [anchor](#snippet-getvalidatedargument)</sup>
<!-- endsnippet -->


## Release Notes

See [closed milestones](../../milestones?state=closed).


## Icon

[Shield](https://thenounproject.com/term/shield/1893182/) designed by [Maxim Kulikov](https://thenounproject.com/maxim221/) from [The Noun Project](https://thenounproject.com)
